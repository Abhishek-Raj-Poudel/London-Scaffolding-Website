---
import Main from "@/layouts/main.astro";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const posts = await getCollection("blogs");
  return posts.map((post) => ({
    params: { slug: post.slug },
    props: { post },
  }));
}

const { post } = Astro.props;
const { Content, headings } = await post.render();
const tocHeadings = headings.filter((h) => h.depth <= 3);

const wordCount = post.body.split(/\s+/g).length;
const readTime = Math.ceil(wordCount / 200);
---

<Main
  content={{
    title: `${post.data.title} | London Scaffolding`,
    description: post.data.description,
  }}
>
  <!-- Hero Section -->
  <section
    class="bg-primary text-white py-20 border-b border-white/10 relative overflow-hidden"
  >
    {
      post.data.image && (
        <div class="absolute inset-0 opacity-20">
          <img
            src={post.data.image.src}
            alt=""
            class="w-full h-full object-cover"
          />
        </div>
      )
    }
    <div class="wrapper relative z-10">
      <div class="max-w-4xl flex flex-col gap-6">
        <div class="text-white/60 text-sm font-bold uppercase tracking-widest">
          {
            post.data.pubDate.toLocaleDateString("en-GB", {
              day: "numeric",
              month: "long",
              year: "numeric",
            })
          }
        </div>
        <h1 class="typo-5xl">{post.data.title}</h1>
        <p class="typo-xl text-white/90 leading-relaxed">
          {post.data.description}
        </p>
        <div class="flex items-center gap-2 text-white/60 text-sm font-medium">
          <svg
            class="w-4 h-4"
            fill="none"
            viewBox="0 0 24 24"
            stroke="currentColor"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
          </svg>
          {readTime} minute read
        </div>
      </div>
    </div>
  </section>

  {/* Breadcrumb */}
  <div class="border-b border-slate-100 bg-slate-50/50">
    <div class="wrapper py-4">
      <nav class="flex text-sm text-muted-foreground">
        <ol class="flex items-center gap-2">
          <li>
            <a href="/" class="hover:text-primary transition-colors">Home</a>
          </li>
          <li class="text-slate-300">/</li>
          <li>
            <a href="/blog" class="hover:text-primary transition-colors">Blog</a
            >
          </li>
          <li class="text-slate-300">/</li>
          <li
            class="text-slate-900 font-medium truncate max-w-[200px] sm:max-w-none"
          >
            {post.data.title}
          </li>
        </ol>
      </nav>
    </div>
  </div>

  <!-- Main Content -->
  <section class="">
    <div class="wrapper grid grid-cols-1 lg:grid-cols-3 gap-12">
      <div class="lg:col-span-2 prose prose-slate max-w-none">
        <Content />
      </div>

      <!-- Sidebar / Table of Contents -->
      <aside class="space-y-8 h-fit sticky top-24">
        <div class="bg-muted/30 p-8 rounded-2xl">
          <h3 class="typo-xl font-bold mb-4">Table of Contents</h3>
          <ul class="space-y-3">
            {
              tocHeadings.length > 0 ? (
                tocHeadings.map((h) => (
                  <li
                    class={`text-sm transition-colors hover:text-primary ${h.depth === 3 ? "pl-4 text-muted-foreground" : "text-slate-700 font-medium"}`}
                  >
                    <a href={`#${h.slug}`}>{h.text}</a>
                  </li>
                ))
              ) : (
                <li class="text-sm text-muted-foreground italic">
                  No subsections in this article.
                </li>
              )
            }
          </ul>
        </div>
      </aside>
    </div>
  </section>
</Main>

<style is:global>
  @reference "../../styles/global.css";

  .prose h2 {
    @apply typo-3xl mt-12 mb-6 scroll-mt-24;
  }
  .prose h3 {
    @apply typo-2xl mt-8 mb-4 scroll-mt-24;
  }
  .prose p {
    @apply typo-lg leading-relaxed mb-6;
  }
  .prose ul {
    @apply list-disc list-inside mb-6 space-y-2 typo-lg;
  }
  .prose li {
    @apply marker:text-primary;
  }
</style>
